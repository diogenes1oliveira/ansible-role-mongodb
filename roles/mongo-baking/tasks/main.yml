---
# tasks file for baker

- name: Adding the mongodb repository
  copy:
    src: './mongodb.repo'
    dest: '/etc/yum.repos.d/'
    mode: 0644

- name: Adding the extra repository to install pip
  yum:
    name: epel-release
    state: present

- name: Install MongoDB, pip and jq
  yum:
    name:
      - mongodb-org
      - python-pip
      - jq
    state: present

- name: Install pymongo and pyopenssl
  pip:
    name:
      - pymongo
      - pyopenssl
    state: present

- name: Disable transparent huge pages
  block:
    - name: Copy the disabler script
      copy:
        src: 'disable-thp.sh'
        dest: '/bin/disable-thp.sh'
        mode: 0755

    - name: Copy the service file
      copy:
        src: 'disable-thp.service'
        dest: '/etc/systemd/system/disable-thp.service'
        mode: 0755

    - name: Enable the service
      service:
        name: disable-thp
        state: started
        enabled: true

- name: Copy the initial configuration file
  copy:
    src: 'mongod.conf'
    dest: '/etc/mongod.conf'
    mode: 0644
    group: mongod
    owner: mongod

- name: Assure mongod is started
  block:
    - name: Try to start the service
      service:
        name: mongod
        enabled: true
        state: started
  rescue:
    - name: Disable the service
      service:
        name: mongod
        enabled: false
        state: stopped

    - name: Assure proper permissions
      file:
        path: "{{ item }}"
        recurse: true
        mode: 0755
        group: mongod
        owner: mongod
      with_items:
        - /var/log/mongodb/
        - /var/lib/mongo/

    - name: Remove temporary files
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /tmp/mongodb-27017.sock
        - /var/run/mongodb/mongod.pid

    - name: Try to start again
      service:
        name: mongod
        enabled: true
        state: started
